import com.android.build.gradle.internal.tasks.factory.dependsOn
import org.jetbrains.kotlin.gradle.tasks.Kotlin2JsCompile

plugins {
    id("kotlin2js")
}
repositories {
    mavenLocal()
    mavenCentral()
    jcenter()
    maven { url "http://dl.bintray.com/kotlin/kotlin-dev" }
    maven { url "http://dl.bintray.com/kotlinx/kotlinx" }
    maven { url "http://dl.bintray.com/kotlin/kotlin-js-wrappers" }
}


dependencies {
    implementation(kotlin("stdlib-js"))
    implementation(project(":MOELibraries"))
    compile ("org.jetbrains.kotlin:kotlin-stdlib-js:$kotlin_version"
    compile ("org.jetbrains.kotlinx:kotlinx-html-js:$kotlinx_html_version"
    compile "org.jetbrains:kotlin-react:$react_version"
    compile "org.jetbrains:kotlin-react-dom:$react_dom_version"
    testImplementation("org.jetbrains.kotlin:kotlin-test-js")
    testImplementation("org.jetbrains.kotlin:kotlin-test-nodejs-runner")
}

tasks {
    compileKotlin2Js {
        kotlinOptions {
            moduleKind = "commonjs"
//            outputFile = "node/index.js"
            sourceMap = true
        }
    }
//    compileKotlin2Js {
//        kotlinOptions {
//            outputFile = "${sourceSets.main.get().output.resourcesDir}/output.js"
//            sourceMap = true
//        }
//    }
    val unpackKotlinJsStdlib by registering {
        group = "build"
        description = "Unpack the Kotlin JavaScript standard library"
        val outputDir = file("$buildDir/$name")
        inputs.property("compileClasspath", configurations.compileClasspath.get())
        outputs.dir(outputDir)
        doLast {
            val kotlinStdLibJar = configurations.compileClasspath.get().single {
                it.name.matches(Regex("kotlin-stdlib-js-.+\\.jar"))
            }
            copy {
                includeEmptyDirs = false
                from(zipTree(kotlinStdLibJar))
                into(outputDir)
                include("**/*.js")
                exclude("META-INF/**")
            }
        }
    }
    val pullLibs by registering(Copy::class) {
        group = "build"

        includeEmptyDirs = false
        val libPath = rootProject.buildDir.toString() + "/js/packages/MOETime-MOELibraries/kotlin"
        from(unpackKotlinJsStdlib)
        from(libPath) {
            exclude("**/*.kjsm")
        }
        into(rootProject.file("JsApp/web/node_modules"))
    }
    val assembleWeb by registering(Copy::class) {
        group = "build"
        description = "Assemble the web application"
        includeEmptyDirs = false
//        val libPath = rootProject.buildDir.toString()+"/js/packages/MOETime-MOELibraries")
        //   println(project.file(package.json))
        //from()

        from(sourceSets.main.get().output) {
            exclude("**/*.kjsm")
        }
        into("$buildDir/web")
    }
    assembleWeb {
        dependsOn(pullLibs)
    }
    assemble {
        dependsOn(assembleWeb)
    }
    val npmInit by registering(Exec::class) {
        commandLine("cmd", "/c", "npm", "init", "-y")
    }

    val npmInstall by registering(Exec::class) {
        commandLine("cmd", "/c", "npm", "install", "kotlin", "express", "--save")
    }

    val npmRun by registering(Exec::class) {


        commandLine("node", "build/web/JsApp.js")
    }

    npmRun.dependsOn(assemble)
}
